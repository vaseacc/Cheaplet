<script>
    // IMPORTANT: Replace with your actual configuration from the Firebase console
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.addEventListener('DOMContentLoaded', function() {
        const listingsGrid = document.querySelector('.listings-grid');
        const listingsCount = document.querySelector('.listings-header span');
        
        // --- MODAL AND FORM ELEMENTS ---
        const modal = document.getElementById('listingModal');
        const listAnItemBtn = document.querySelector('.header-content .btn'); // The button in the header
        const closeBtn = document.querySelector('.close-btn');
        const listingForm = document.getElementById('listingForm');

        // --- FUNCTIONS ---
        
        // Function to open the modal
        function openModal() {
            modal.style.display = 'block';
        }

        // Function to close the modal
        function closeModal() {
            modal.style.display = 'none';
        }
        
        // Function to render a single listing card
        function renderListing(doc) {
            const listing = doc.data();
            const card = `
                <div class="listing-card" data-id="${doc.id}">
                    <div class="listing-image">Image</div>
                    <div class="listing-details">
                        <div class="listing-price">$${listing.price}</div>
                        <h3 class="listing-title">${listing.title}</h3>
                        <div class="listing-location">${listing.location}</div>
                        <div class="listing-meta">
                            <span>${new Date(listing.timestamp.seconds * 1000).toLocaleDateString()}</span>
                            <span>${listing.category}</span>
                        </div>
                    </div>
                </div>
            `;
            // Prepend new items so they appear at the top without a refresh
            listingsGrid.insertAdjacentHTML('afterbegin', card);
        }
        
        // Function to fetch all listings from Firestore
        function fetchListings() {
            db.collection('listings').orderBy('timestamp', 'desc').get().then(snapshot => {
                listingsGrid.innerHTML = ''; // Clear static listings
                listingsCount.textContent = `${snapshot.size} items found`;
                snapshot.forEach(doc => {
                    // This re-renders every card, but it's fine for now
                    const listing = doc.data();
                    const cardHTML = `
                        <div class="listing-card" data-id="${doc.id}">
                            <div class="listing-image">Image</div>
                            <div class="listing-details">
                                <div class="listing-price">$${listing.price}</div>
                                <h3 class="listing-title">${listing.title}</h3>
                                <div class="listing-location">${listing.location}</div>
                                <div class="listing-meta">
                                    <span>${new Date(listing.timestamp.seconds * 1000).toLocaleDateString()}</span>
                                    <span>${listing.category}</span>
                                </div>
                            </div>
                        </div>
                    `;
                    listingsGrid.innerHTML += cardHTML;
                });
            }).catch(error => {
                console.error("Error fetching listings: ", error);
            });
        }

        // --- EVENT LISTENERS ---

        // Listen for clicks on the main "List an Item" button to open the modal
        listAnItemBtn.addEventListener('click', openModal);

        // Listen for clicks on the 'X' to close the modal
        closeBtn.addEventListener('click', closeModal);

        // Close the modal if user clicks outside of the content area
        window.addEventListener('click', function(event) {
            if (event.target == modal) {
                closeModal();
            }
        });

        // Listen for the form submission
        listingForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the page from reloading

            // Get values from the form
            const newItem = {
                title: listingForm.itemTitle.value,
                price: Number(listingForm.itemPrice.value),
                location: listingForm.itemLocation.value,
                category: listingForm.itemCategory.value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // Use server time
            };

            // Save the new item to Firestore
            db.collection('listings').add(newItem).then(() => {
                console.log('Listing added successfully!');
                listingForm.reset(); // Clear the form fields
                closeModal(); // Close the modal
                fetchListings(); // Refresh the listings on the page
            }).catch(error => {
                console.error("Error adding document: ", error);
                alert("There was an error submitting your listing. Please try again.");
            });
        });
        
        // --- INITIAL LOAD ---
        fetchListings();
        
    });
</script>
